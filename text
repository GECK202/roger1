#Сброс настройки Nat Network VM
#Размер раздела:
#4509700000 B
#Узнать размер sudo fdisk -l

#Настройка сети Nat Network

#Обновить пакеты
apt update
apt upgrade

#Установка sudo:
apt install sudo

#Добавление serveruser в sudoers:
echo "serveruser ALL = (ALL) ALL" >> /etc/sudoers

#Изменить настройки сети:
#Редактировать файл /etc/network/interfaces:
#auto enp0s3
#iface enp0s3 inet static
#	address		10.0.2.2
#	netmask		255.255.255.252
#	network		10.0.2.0
#	broadcast	10.0.2.255
#	gateway		10.0.2.1
#	dns-nameservers	10.0.2.1
sed -i 's/dhcp/static/' /etc/network/interfaces
sed -i 's/allow-hotplug/auto/' /etc/network/interfaces
echo -e "\taddress\t\t10.0.2.2" >> /etc/network/interfaces 
echo -e "\tnetmask\t\t255.255.255.252" >> /etc/network/interfaces
echo -e "\tnetwork\t\t10.0.2.0" >> /etc/network/interfaces
echo -e "\tbroadcast\t10.0.2.255" >> /etc/network/interfaces
echo -e "\tgateway\t\t10.0.2.1" >> /etc/network/interfaces
echo -e "\tdns-nameservers\t10.0.2.1" >> /etc/network/interfaces

#Изменить файл /etc/ssh/sshd_config:
#Добавить строку:
#Port 50022
echo "Port 50022" >> /etc/ssh/sshd_config

#Выключить VM
#Отключить в настройках сети dhcp
#На хосте узнать ip
#Пробросить порт
#Запустить VM


#На хосте сгенерировать ssh ключи:
#ssh-keygen
#Скопировать публичный ключ на сервер:
#ssh-copy-id serveruser@192.168.21.74 -p9922

#Подключиться по ssh:
#ssh serveruser@192.168.21.72 -p9922

#Отредактировать файл /etc/ssh/sshd_config для запрета доступа root и доступа по паролю:
#Добавить строки:
#PasswordAuthentication no
#PermitRootLogin no
echo "PasswordAuthentication no" >> /etc/ssh/sshd_config
echo "PermitRootLogin no" >> /etc/ssh/sshd_config

#Защита DDOS:
#sudo apt-get install fail2ban

#Настройка файрвола:

apt install ufw
sudo ufw allow 443
sudo ufw allow 80/tcp
sudo ufw allow 50113/tcp

#РАБОТАЕТ ТОЛЬКО С СЕРВЕРА
#установка правил по умолчанию: запрет на всё:
#sudo iptables -P INPUT DROP
#sudo iptables -P OUTPUT DROP
#sudo iptables -P FORWARD DROP

#sudo iptables -A INPUT -i lo -j ACCEPT
#sudo iptables -A OUTPUT -o lo -j ACCEPT

#sudo iptables -A OUTPUT -o enp0s3 -j ACCEPT

#sudo iptables -A INPUT -i enp0s3 -p tcp --dport 50022 -j ACCEPT
#sudo iptables -A INPUT -i enp0s3 -p tcp --dport 80 -j ACCEPT
#sudo iptables -A INPUT -i enp0s3 -p tcp --dport 443 -j ACCEPT


#Установка и настройка веб-сервера apache:
# sudo apt install apache2

# настройка фаервола
# sudo ufw allow 'WWW'

# проверка веб сервера
# sudo systemctl status apache2

# чтобы убедиться что всё работает - пробросить 80 порт и проверить в браузере

# создать каталог для сайта
# sudo mkdir -p /var/www/example.com/html

# назначить владельца каталога
#sudo chown -R $USER:$USER /var/www/example.com/html

# создать index.html сайта
# nano /var/www/example.com/html/index.html
# и наполнить:
# <html>
#    <head>
#        <title>Welcome to Example.com!</title>
#    </head>
#    <body>
#        <h1>Success!  The example.com virtual host is working!</h1>
#    </body>
# </html>

# создать файл конфигурации
# sudo nano /etc/apache2/sites-available/example.com.conf
# и заполнить его:
# <VirtualHost *:80>
#     ServerAdmin admin@example.com
#     ServerName example.com
#     ServerAlias www.example.com
#     DocumentRoot /var/www/example.com/html
#     ErrorLog ${APACHE_LOG_DIR}/error.log
#     CustomLog ${APACHE_LOG_DIR}/access.log combined
# </VirtualHost>

# активировать сайт
# sudo a2ensite example.com.conf

# деактивировать сайр по умолчанию
# sudo a2dissite 000-default.conf

# проверить на ошибки 
# sudo apache2ctl configtest
# должно быть Syntax OK

# перезапустить apache
# sudo systemctl restart apache2

# проверить в браузере
